
{% extends "layout.html" %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <h1 class="text-gold">Gerenciar Alunos</h1>
        </div>
        <div class="col-md-6 text-md-end">
            <button type="button" class="btn btn-gold" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-user-plus me-2"></i>Novo Aluno
            </button>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" id="userSearch" class="form-control" placeholder="Buscar alunos...">
                        <button class="btn btn-gold">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="userStatus">
                        <option value="all">Todos os Status</option>
                        <option value="active">Ativos</option>
                        <option value="pending">Pendentes</option>
                        <option value="inactive">Inativos</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="bg-navy text-gold">
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Mensalidade</th>
                            <th>Cursos</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar me-3">
                                        {% if user.profile_image_url %}
                                            <img src="{{ user.profile_image_url }}" class="rounded-circle" width="40">
                                        {% else %}
                                            <div class="rounded-circle bg-navy text-gold d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                {{ user.first_name[0] if user.first_name }}{{ user.last_name[0] if user.last_name }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ user.first_name }} {{ user.last_name }}</div>
                                        <small class="text-muted">@{{ user.username }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% if user.is_approved %}
                                    {% if user.is_active %}
                                        <span class="badge bg-success">Ativo</span>
                                    {% else %}
                                        <span class="badge bg-warning">Inativo</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-danger">Pendente</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.last_payment %}
                                    <span class="badge bg-success">Em dia</span>
                                {% else %}
                                    <span class="badge bg-danger">Pendente</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-navy">{{ user.courses|length }} cursos</span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    {% if not user.is_approved %}
                                    <button type="button" class="btn btn-sm btn-success" onclick="approveUser({{ user.id }})">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-outline-gold" onclick="editUser({{ user.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="managePayment({{ user.id }})">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals for user management here -->

<script>
function approveUser(userId) {
    if (confirm('Deseja aprovar este aluno?')) {
        fetch(`/admin/users/${userId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

function editUser(userId) {
    // Implement edit user logic
    window.location.href = `/admin/users/${userId}/edit`;
}

function managePayment(userId) {
    // Implement payment management logic
    window.location.href = `/admin/users/${userId}/payments`;
}

function deleteUser(userId) {
    if (confirm('Tem certeza que deseja excluir este aluno?')) {
        fetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

// Search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('userSearch');
    const statusSelect = document.getElementById('userStatus');

    function filterUsers() {
        const searchTerm = searchInput.value.toLowerCase();
        const status = statusSelect.value;
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const name = row.querySelector('.fw-bold').textContent.toLowerCase();
            const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const userStatus = row.querySelector('td:nth-child(3) .badge').textContent.toLowerCase();

            const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
            const matchesStatus = status === 'all' || userStatus.includes(status);

            row.style.display = matchesSearch && matchesStatus ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterUsers);
    statusSelect.addEventListener('change', filterUsers);
});
</script>
{% endblock %}
